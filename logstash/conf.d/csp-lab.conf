input {
  beats {
    port => 5044
    type => "beats-log"
  }
}

filter {
  if "iis-log" in [tags] {
    grok {
      match => { "message" => '%{IPORHOST:clientHost} (?:-|%{NOTSPACE}) %{NOTSPACE:remote_user} \[%{TIMESTAMP_ISO8601:datetime}\] "%{WORD:method} %{URIPATHPARAM:http_request} %{DATA:request}" %{INT:httpStatus} %{NUMBER:sentBytes} %{NUMBER:timeTaken} "%{DATA:referer}" "%{DATA:userAgent}" "%{IPORHOST:oIP}" %{NOTSPACE:tid} %{NOTSPACE:sid} "%{DATA:uid}" "%{DATA:username}" "%{DATA:serverid}"(?: "%{DATA:lineUserId}")?' } 
    }   
			
    mutate { split => ["[http_request]", "?"] add_field => { "uriStem" => "%{[http_request][0]}" } }
    if [http_request][1] { mutate { add_field => { "uriQuery" => "%{[http_request][1]}" } } }

    mutate { remove_field => ["[http_request]"] }
    ruby {
    code => "
      if event.get('username')
        require 'uri'
        begin
          original = event.get('username').gsub('\"', '')
          decoded_name = URI.decode_www_form_component(original)
          event.set('username', decoded_name)
          rescue => e
          event.set('decode_error', e.message)
        end
      end
    "
    } 
  }

  if "site-log" in [tags] {
    json { source => "message" target => "parsedJson" }
    mutate {
      add_field => {
        "tid" => "%{[parsedJson][TraceId]}"
        "sid" => "%{[parsedJson][SpanId]}"
        "rid" => "%{[parsedJson][RequestID]}"
        "datetime" => "%{[parsedJson][Logtime]}"
        "machine" => "%{[parsedJson][Machine]}"
        "logger" => "%{[parsedJson][Logger]}"        
        "logMessage" => "%{[parsedJson][Message]}"
      }
    }
    grok {
      match => { 
        "logMessage" => "^(?<timeTaken>\S+)\s+(?<service>\S+)\s+(?<command>.+)$" 
      }
    }

    if [service] =~ /BeginRequest|EndRequest/ { drop { } }
  }

  if "host-log" in [tags] {
    json { source => "message" target => "parsedJson" }
    mutate {
      add_field => {
        "tid" => "%{[parsedJson][TraceId]}"
        "sid" => "%{[parsedJson][SpanId]}"
        "rid" => "%{[parsedJson][RequestID]}"
        "datetime" => "%{[parsedJson][Logtime]}"
        "level" => "%{[parsedJson][Level]}"
        "logger" => "%{[parsedJson][Logger]}"
        "uriStem" => "%{[parsedJson][HttpURL]}"
        "clientHost" => "%{[parsedJson][IP]}"
        "headers" => "%{[parsedJson][Headers]}"
        "machine" => "%{[parsedJson][Machine]}"
        "processInfo" => "%{[parsedJson][ProcessInfo]}"
        "logMessage" => "%{[parsedJson][Message]}"
      }
    }
  }

  if "normal-log" in [tags] {
    json { source => "message" target => "parsedJson" }
    mutate {
      add_field => {
        "tid" => "%{[parsedJson][TraceId]}"
        "sid" => "%{[parsedJson][SpanId]}"
        "rid" => "%{[parsedJson][RequestID]}"
        "datetime" => "%{[parsedJson][Logtime]}"
        "machine" => "%{[parsedJson][Machine]}"
        "processInfo" => "%{[parsedJson][ProcessInfo]}"
        "level" => "%{[parsedJson][Level]}"
        "logger" => "%{[parsedJson][Logger]}"
        "logMessage" => "%{[parsedJson][Message]}"
        "exception" => "%{[parsedJson][Exception]}"
      }
    }
  }


  #=== ALL Common =====================================================
  #靜態資源及監控探測不紀錄
  if [uriStem] =~ /\/slb\.aspx|\/signalr\/|\/Content\/|\/Scripts\/|\.css|\.js|\.ico/ { drop { } }
  if [userAgent] =~ /WhatsUp\/1.0/ { drop { } }
  if [message] =~ "^#" { drop { } }
  if [logMessage] =~ /已執行結束./ { drop {} } 

  mutate { convert => { "timeTaken" => "float" } }
  #==== 這裡 timezone => "+00:00" 代表 把 log 上的時間當成 UTC 解析。 如果 log 上的時間是其他時區，請自行調整此參數 ====
  date { match => [ "datetime", "ISO8601", "YYYY-MM-dd HH:mm:ss", "YYYY-MM-dd HH:mm:ss.ZZZ" ] locale => "en" timezone => "+00:00" }
	mutate { remove_field => [ "datetime","message", "parsedJson", "host", "agent", "log", "input", "ecs", "event" ] }

  # ==== data_stream routing ==========================================
  # 設定 Dataset (根據 Log 類型)
  if "iis-log" in [tags] {
    mutate {
      add_field => {
        "[data_stream][type]"    => "logs"
        "[data_stream][dataset]" => "csp-iis"
      }
    }
  } else if "site-log" in [tags] {
    mutate {
      add_field => {
        "[data_stream][type]"    => "logs"
        "[data_stream][dataset]" => "csp-site"
      }
    }
  } else if "host-log" in [tags] {
    mutate {
      add_field => {
        "[data_stream][type]"    => "logs"
        "[data_stream][dataset]" => "csp-host"
      }
    }
  } else if "normal-log" in [tags] {
    mutate {
      add_field => {
        "[data_stream][type]"    => "logs"
        "[data_stream][dataset]" => "csp-normal"
      }
    }
  } else {
    mutate {
      add_field => {
        "[data_stream][type]"    => "logs"
        "[data_stream][dataset]" => "csp-unknown"
      }
    }
  }

  # 設定 Namespace (根據環境標籤)
  if "csp-test" in [tags] {
    mutate { add_field => { "[data_stream][namespace]" => "test" } }
  } else if "csp" in [tags] {
    mutate { add_field => { "[data_stream][namespace]" => "dev" } }
  } else {
    # 若無明確標籤，預設為 dev
    mutate { add_field => { "[data_stream][namespace]" => "dev" } }
  }

}

output {
  elasticsearch {
    hosts => ["https://es01:9200"]
    user => "elastic"
    password => "${ELASTIC_PASSWORD}"
    ssl_enabled => true
    ssl_verification_mode => "none"

    # ★ 啟用 Data Stream 模式
    data_stream => true
    data_stream_auto_routing => true
  }
}
